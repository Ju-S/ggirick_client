<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="WorkSummaryDaily">

    <!-- ê·¼ë¬´ê¸°ë¡ ìš”ì•½ í…Œì´ë¸” MERGE -->
    <update id="merge" parameterType="com.kedu.ggirick_client_backend.dto.workmanagement.WorkSummaryDailyDTO">
        MERGE INTO WORK_SUMMARY_DAILY s
        USING (
        SELECT
        #{employeeId} AS EMPLOYEE_ID,
        #{workDate, jdbcType=DATE} AS WORK_DATE
        FROM dual
        ) t
        ON (
        s.EMPLOYEE_ID = t.EMPLOYEE_ID
        AND TRUNC(s.WORK_DATE) = TRUNC(t.WORK_DATE)   <!-- âœ… ë‘˜ ë‹¤ TRUNC -->
        )
        WHEN MATCHED THEN
        UPDATE SET
        s.START_TIME      = #{startTime, jdbcType=TIMESTAMP},
        s.END_TIME        = #{endTime, jdbcType=TIMESTAMP},
        s.TOTAL_HOURS     = #{totalHours, jdbcType=NUMERIC},
        s.WORK_HOURS      = #{totalHours, jdbcType=NUMERIC},
        s.OVERTIME_HOURS  = #{overtimeHours, jdbcType=NUMERIC},
        s.NIGHT_HOURS     = #{nightHours, jdbcType=NUMERIC},
        s.LEAVE_HOURS     = #{leaveHours, jdbcType=NUMERIC},
        s.STATUS          = #{status, jdbcType=VARCHAR}
        WHEN NOT MATCHED THEN
        INSERT (
        EMPLOYEE_ID, WORK_DATE, START_TIME, END_TIME,
        TOTAL_HOURS, WORK_HOURS, OVERTIME_HOURS,
        NIGHT_HOURS, LEAVE_HOURS, STATUS
        )
        VALUES (
        #{employeeId},
        TRUNC(#{workDate, jdbcType=DATE}),   <!-- âœ… ì €ìž¥ ì‹œì—ë„ TRUNC -->
        #{startTime, jdbcType=TIMESTAMP},
        #{endTime, jdbcType=TIMESTAMP},
        #{totalHours, jdbcType=NUMERIC},
        #{totalHours, jdbcType=NUMERIC},
        #{overtimeHours, jdbcType=NUMERIC},
        #{nightHours, jdbcType=NUMERIC},
        #{leaveHours, jdbcType=NUMERIC},
        #{status, jdbcType=VARCHAR}
        )
    </update>

    <!-- í†µí•© ê·¼ë¬´ìš”ì•½ (ì¼ê°„ / ì£¼ê°„ / ì—°ê°„ / ì§ì ‘ ê¸°ê°„) -->
    <select id="getWorkSummary"
            parameterType="map"
            resultType="com.kedu.ggirick_client_backend.dto.workmanagement.WorkSummaryDTO">

        SELECT
            -- ì§€ê° ì¹´ìš´íŠ¸ (LATE ë˜ëŠ” LATE_EARLY_LEAVE í¬í•¨)
            NVL(SUM(CASE WHEN s.STATUS LIKE '%LATE%' THEN 1 ELSE 0 END), 0) AS late_count,

            -- ì¡°í‡´ ì¹´ìš´íŠ¸
            NVL(SUM(CASE WHEN s.STATUS LIKE '%EARLY_LEAVE%' THEN 1 ELSE 0 END), 0) AS early_leave_count,

            -- ë¯¸í‡´ê·¼
            NVL(SUM(CASE WHEN s.STATUS LIKE '%MISSING_OUT%' THEN 1 ELSE 0 END), 0) AS missing_out_count,

            -- ê²°ê·¼
            NVL(SUM(CASE WHEN s.STATUS LIKE '%ABSENT%' THEN 1 ELSE 0 END), 0) AS absent_count,

            -- ê·¼ë¬´ì¼ìˆ˜ (ê²°ê·¼ ì œì™¸)
            NVL(SUM(CASE WHEN s.STATUS NOT LIKE '%ABSENT%' THEN 1 ELSE 0 END), 0) AS work_days,

            -- ì´ ê·¼ë¬´ì‹œê°„
            ROUND(NVL(SUM(s.TOTAL_HOURS), 0), 1) AS total_hours,

            -- í‰ê·  ê·¼ë¬´ì‹œê°„
            ROUND(NVL(AVG(NVL(s.TOTAL_HOURS, 0)), 0), 1) AS avg_hours,

            -- ðŸ”¹ ìž”ì—¬ì—°ì°¨ (ì†Œìˆ˜ì  ìœ ì§€)
            ROUND(NVL(MAX(g.remaining_vacation), 0), 1) AS remaining_vacation,

            -- ì´ íœ´ê°€ ì‚¬ìš©ì‹œê°„
            ROUND(NVL(SUM(s.LEAVE_HOURS), 0), 1) AS leave_hours

        FROM WORK_SUMMARY_DAILY s
                 LEFT JOIN (
            SELECT employee_id,
                   SUM((days_granted - days_used) * 1.0) AS remaining_vacation
            FROM ANNUAL_LEAVE_GRANT
            WHERE expire_date >= SYSDATE
            GROUP BY employee_id
        ) g ON g.employee_id = s.employee_id

        WHERE s.employee_id = #{employeeId}
          AND s.work_date BETWEEN #{startDate} AND #{endDate}

    </select>
</mapper>
