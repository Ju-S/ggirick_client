<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Mail">

    <!-- uid 중복 방지 -->
    <select id="existsByUid" parameterType="string" resultType="int">
        SELECT 1
        FROM mail
        WHERE mail_uid = #{mailUid}
    </select>

    <!-- IMAP 수신용 메일 insert -->
    <insert id="addMail" parameterType="com.kedu.ggirick_client_backend.dto.mail.MailDTO">
        <selectKey order="BEFORE" keyProperty="id" resultType="int">
            SELECT mail_seq.nextval FROM dual
        </selectKey>
        INSERT INTO mail (id, sender, title, content, status, sent_at, mail_uid)
        VALUES (#{id}, #{sender}, <![CDATA[#{title}]]>, <![CDATA[#{content}]]>, #{status}, #{sentAt,jdbcType=TIMESTAMP}, #{mailUid})
    </insert>

    <!-- 발신 메일 저장 -->
    <insert id="sendMail" parameterType="com.kedu.ggirick_client_backend.dto.mail.MailSendDTO">
        <selectKey keyProperty="id" resultType="int" order="BEFORE">
            SELECT mail_seq.nextval FROM dual
        </selectKey>
        INSERT INTO mail (
        id,
        sender,
        title,
        content,
        status,
        scheduled
        <if test="sendAt != null">, sent_at</if>
        )
        VALUES (
        #{id},
        #{sender},
        <![CDATA[#{subject}]]>,
        <![CDATA[#{content}]]>,
        1,
        #{scheduled}
        <if test="sendAt != null">, #{sendAt,jdbcType=TIMESTAMP}</if>
        )
    </insert>

    <!-- 수신자 insert (TO/CC/BCC), null-safe -->
    <insert id="insertReceiver" parameterType="com.kedu.ggirick_client_backend.dto.mail.MailReceiverDTO">
        INSERT INTO mail_receiver (id, mail_id, receiver, type_id, status_id, received_at)
        VALUES (
        mail_receiver_seq.nextval,
        #{mailId},
        #{receiver},
        #{typeId},
        #{statusId},
        #{receivedAt,jdbcType=TIMESTAMP} <!-- null-safe -->
        )
    </insert>

    <!-- 첨부파일 단일 insert -->
    <insert id="sendAttachmentsSingle" parameterType="map">
        INSERT INTO mail_file (id, name, url, mail_id)
        VALUES (mail_file_seq.nextval, #{filename}, #{fileUrl}, #{mailId})
    </insert>

    <!-- 여러 첨부용 foreach -->
    <insert id="sendAttachments" parameterType="com.kedu.ggirick_client_backend.dto.mail.MailSendDTO">
        <foreach collection="fileUrlMap" item="fileUrl" index="fileName" separator=";">
            INSERT INTO mail_file (id, name, url, mail_id)
            VALUES (mail_file_seq.nextval, #{fileName}, #{fileUrl}, #{id})
        </foreach>
    </insert>

    <!-- 이메일 → 사번 조회 -->
    <select id="findEmployeeIdByEmail" parameterType="string" resultType="string">
        SELECT id
        FROM (
                 SELECT id
                 FROM employee
                 WHERE email = #{email}
                    OR id = SUBSTR(
                         #{email},
                         1,
                         CASE
                             WHEN INSTR(#{email}, '@') > 0 THEN INSTR(#{email}, '@') - 1
                             ELSE LENGTH(#{email})
                             END
                            )
             )
        WHERE ROWNUM = 1
    </select>

    <!-- 예약메일 목록 조회 -->
    <select id="getScheduledMails" resultType="com.kedu.ggirick_client_backend.dto.mail.MailSendDTO">
        SELECT *
        FROM mail
        WHERE scheduled = 1
        AND sent_at &lt;= SYSDATE
    </select>

    <!-- 예약 메일 수신자 조회 -->
    <select id="getMailReceivers" resultType="com.kedu.ggirick_client_backend.dto.mail.MailReceiverDTO" parameterType="int">
        SELECT id,
               mail_id AS mailId,
               receiver,
               received_at AS receivedAt,
               type_id AS typeId,
               status_id AS statusId
        FROM mail_receiver
        WHERE mail_id = #{mailId}
    </select>

    <!-- 예약 발송 후 상태 해제 -->
    <update id="markAsSent" parameterType="int">
        UPDATE mail
        SET scheduled = 0
        WHERE id = #{mailId}
    </update>

    <!-- 특정 메일 조회 -->
    <select id="getMailById" parameterType="int" resultType="com.kedu.ggirick_client_backend.dto.mail.MailSendDTO">
        SELECT id, sender, title, content, status, sent_at AS sendAt, mail_uid AS mailUid, scheduled
        FROM mail
        WHERE id = #{id}
    </select>

</mapper>