<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AnnualLeaveGrant">

    <!-- 연차 부여 등록 -->
    <insert id="insertAnnualLeaveGrant">
        INSERT INTO annual_leave_grant (
        grant_id, employee_id, grant_date, expire_date,
        days_granted, days_used, reason, created_at
        ) VALUES (
        annual_leave_grant_seq.NEXTVAL,
        #{employeeId},
        #{grantDate},
        #{expireDate},
        #{daysGranted},
        NVL(#{daysUsed}, 0),
        #{reason},
        SYSDATE
        )
    </insert>

    <!-- 사용일수 갱신 -->
    <update id="updateAnnualLeaveGrantUsage">
        UPDATE annual_leave_grant
        SET
        days_used = #{daysUsed},
        updated_at = SYSDATE
        WHERE grant_id = #{grantId}
    </update>

    <!-- 가장 최근에 부여한 연차 부여 이력 조회 -->
    <select id="getLatestGrantByEmployee" resultType="com.kedu.ggirick_client_backend.dto.hr.AnnualLeaveGrantDTO">
        SELECT *
        FROM (
        SELECT *
        FROM ANNUAL_LEAVE_GRANT
        WHERE EMPLOYEE_ID = #{employeeId}
        ORDER BY GRANT_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>

    <!--  남은 연차 일수 합계 조회 -->
    <select id="getRemainingVacation" resultType="double">
        SELECT NVL(SUM(days_granted - days_used), 0)
        FROM annual_leave_grant
        WHERE employee_id = #{employeeId}
        AND expire_date >= SYSDATE
    </select>

    <!-- 직원별 연차 목록 조회 -->
    <select id="getAnnualLeaveListByEmployeeId" resultType="com.kedu.ggirick_client_backend.dto.hr.AnnualLeaveGrantDTO">
        SELECT *
        FROM annual_leave_grant
        WHERE employee_id = #{employeeId}
        ORDER BY grant_date DESC
    </select>
</mapper>